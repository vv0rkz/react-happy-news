#!/usr/bin/env sh

COMMIT_MSG=$(cat "$1")

# Функция показа подсказки
show_help() {
    echo ""
    echo "🎯 РАЗРЕШЕННЫЕ ФОРМАТЫ КОММИТОВ:"
    echo "────────────────────────────────────"
    echo "✨ НОВЫЕ ФИЧИ:    feat: #номер описание"
    echo "🐛 ИСПРАВЛЕНИЯ:   fix: #номер описание"  
    echo "🔧 РЕФАКТОРИНГ:   refactor: описание"
    echo "🏗️  ИНФРАСТРУКТУРА: build: описание"
    echo "🛠️  ТЕХ. ЗАДАЧИ:  chore: описание"
    echo "📚 ДОКУМЕНТАЦИЯ:  docs: описание"
    echo "🚀 АВТО-РЕЛИЗЫ:   chore(release): vX.X.X"
    echo ""
    echo "📝 ПРИМЕРЫ:"
    echo "  feat: #9 добавить нормализацию чисел"
    echo "  fix: #10 исправить валидацию операторов"
    echo "  refactor: оптимизировать алгоритм"
    echo "  chore: обновить зависимости"
    echo "  docs: обновить README"
    echo "  chore(release): v2.3.0"
    echo "────────────────────────────────────"
    exit 1
}

# ИСКЛЮЧЕНИЕ: разрешаем авто-релизные коммиты от changelogen
if echo "$COMMIT_MSG" | grep -q "^chore(release): v[0-9]\+\.[0-9]\+\.[0-9]\+$"; then
    echo "✅ Авто-релизный коммит: $COMMIT_MSG"
    exit 0
fi

# СТРОГАЯ ПРОВЕРКА для обычных коммитов
if ! echo "$COMMIT_MSG" | grep -q -E "^(feat: #[0-9]+ .+|fix: #[0-9]+ .+|refactor: .+|build: .+|chore: .+|docs: .+)"; then
    echo "❌ Неправильный формат коммита: '$COMMIT_MSG'"
    show_help
fi

# Дополнительная проверка: feat/fix должны иметь #номер
if echo "$COMMIT_MSG" | grep -q "^\(feat\|fix\):"; then
    if ! echo "$COMMIT_MSG" | grep -q "^\(feat\|fix\): #[0-9]"; then
        echo "❌ Ошибка: feat и fix коммиты должны содержать номер задачи"
        echo "💡 Твой коммит: $COMMIT_MSG"
        echo "✅ Пример: feat: #9 добавить нормализацию чисел"
        exit 1
    fi
fi

# Закрытие issues при fix: #номер
if echo "$COMMIT_MSG" | grep -q "^fix: #[0-9]"; then
    ISSUE_NUMBER=$(echo "$COMMIT_MSG" | grep -o '#[0-9]*' | sed 's/#//')
    echo "🔧 Закрываю issue #$ISSUE_NUMBER..."
    
    COMMIT_HASH=$(git rev-parse --short HEAD)
    REPO_URL=$(git remote get-url origin | sed 's/\.git$//')
    COMMIT_URL="$REPO_URL/commit/$COMMIT_HASH"
    
    gh issue close "$ISSUE_NUMBER" --comment "Исправлено в коммите: [$COMMIT_HASH]($COMMIT_URL) - $COMMIT_MSG"
fi

# Запускаем commitlint
npx --no -- commitlint --edit "$1"