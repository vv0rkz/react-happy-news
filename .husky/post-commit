#!/usr/bin/env sh

COMMIT_MSG=$(git log -1 --pretty=%B)
COMMIT_HASH=$(git rev-parse --short HEAD)
REPO_URL=$(git remote get-url origin)

# –ò—Å–ø—Ä–∞–≤–ª—è–µ–º URL
if echo "$REPO_URL" | grep -q "git@github.com"; then
    REPO_URL=$(echo "$REPO_URL" | sed 's/git@github.com:/https:\/\/github.com\//' | sed 's/\.git$//')
else
    REPO_URL=$(echo "$REPO_URL" | sed 's/\.git$//')
fi

# –ü—É—à –∫–æ–º–º–∏—Ç–∞
git push origin HEAD

# –ó–∞–∫—Ä—ã—Ç–∏–µ issues –ø—Ä–∏ feat: #–Ω–æ–º–µ—Ä –ò fix: #–Ω–æ–º–µ—Ä
if echo "$COMMIT_MSG" | grep -q "^\(feat\|fix\): #[0-9]"; then
    ISSUE_NUMBER=$(echo "$COMMIT_MSG" | grep -o '#[0-9]*' | sed 's/#//')
    echo "üîß –ó–∞–∫—Ä—ã–≤–∞—é issue #$ISSUE_NUMBER..."
    
    COMMIT_LINK="$REPO_URL/commit/$COMMIT_HASH"
    
    gh issue close "$ISSUE_NUMBER" --comment "‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ –≤ –∫–æ–º–º–∏—Ç–µ: [$COMMIT_HASH]($COMMIT_LINK) - $COMMIT_MSG"
fi
